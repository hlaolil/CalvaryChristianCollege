<!DOCTYPE html>
<html lang="en">
<%- include('partials/head', { title: title }) %>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* General Form Styling */
    .contact-form {
      max-width: 100%;
      margin: 1.5rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .contact-form label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: block;
    }
    .contact-form input,
    .contact-form textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .contact-form input[readonly] {
      background: #f5f5f5;
      color: #555;
    }
    .contact-form textarea {
      resize: vertical;
      min-height: 120px;
    }
    .contact-form button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 0.85rem 1.5rem;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      align-self: flex-start;
      margin-top: 0.5rem;
    }
    .contact-form button:hover {
      background: #1565c0;
    }

    /* Responsive Tables */
    .table-wrapper {
      overflow-x: auto;
      margin: 1.5rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .95rem;
    }
    th, td {
      padding: .75rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    thead th {
      background: #e3f2fd;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:hover {
      background: #f9f9f9;
    }

    /* Mobile: Stack table rows */
    @media (max-width: 640px) {
      .table-wrapper { overflow-x: hidden; }
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr {
        margin-bottom: 1.2rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        background: #fafafa;
        box-shadow: 0 1px 3px rgba(0,0,0,.08);
      }
      td {
        border: none;
        position: relative;
        padding-left: 50%;
        padding-top: .5rem;
        padding-bottom: .5rem;
      }
      td:before {
        content: attr(data-label);
        position: absolute;
        left: 12px;
        width: 45%;
        font-weight: bold;
        color: #444;
        white-space: nowrap;
      }
      td.message-cell {
        padding-left: 12px;
        white-space: normal;
        word-wrap: break-word;
      }
    }

    /* Message column width on desktop */
    @media (min-width: 641px) {
      td.message-cell {
        max-width: 400px;
        word-wrap: break-word;
      }
    }

    /* Success / Error */
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }

    /* Back link */
    main a {
      color: #1976d2;
      text-decoration: none;
    }
    main a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  <main class="container">
    <h1>Contact Us</h1>
    <% if (success) { %>
      <p class="success">Thank you! Your message has been sent.</p>
    <% } %>
    <% if (error) { %>
      <p class="error"><%= error %></p>
    <% } %>

    <!-- ==================== CONTACT FORM ==================== -->
    <form class="contact-form" action="/contact" method="POST">
      <label>Name *:</label>
      <input type="text" name="name" required value="<%= user?.name || '' %>" <%= user ? 'readonly' : '' %>>

      <label>Email *:</label>
      <input type="email" name="email" required value="<%= user?.email || '' %>" <%= user ? 'readonly' : '' %>>

      <label>Phone (Optional):</label>
      <input type="tel" name="phone" placeholder="+266 1234 5678">

      <label>Message *:</label>
      <textarea name="message" rows="6" required placeholder="How can we help you?"></textarea>

      <button type="submit">Send Message</button>
    </form>

    <p><a href="/">Back to Home</a></p>

    <!-- ==================== ADMIN: USERS + CONTACTS ==================== -->
    <% if (user?.role === 'admin') { %>

      <!-- === ALL USERS === -->
      <hr>
      <h2>All Registered Users</h2>
      <% if (users && users.length > 0) { %>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Joined</th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach((u, i) => { %>
                <tr>
                  <td data-label="#"> <%= i + 1 %> </td>
                  <td data-label="Name"> <%= u.name || '—' %> </td>
                  <td data-label="Email"> <%= u.email %> </td>
                  <td data-label="Role">
                    <span style="padding:3px 8px; border-radius:4px; font-weight:bold; color:white; background:<%= u.role === 'admin' ? '#d32f2f' : '#1976d2' %>">
                      <%= (u.role || 'user').toUpperCase() %>
                    </span>
                  </td>
                  <td data-label="Joined">
                    <%= u.createdAt ? new Date(u.createdAt).toLocaleString('en-LS', { timeZone: 'Africa/Maseru' }) : '—' %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <p><em>No users found.</em></p>
      <% } %>

      <!-- === ALL CONTACT MESSAGES === -->
      <hr>
      <h2>All Contact Form Submissions</h2>
      <% if (contacts && contacts.length > 0) { %>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Message</th>
                <th>Submitted</th>
              </tr>
            </thead>
            <tbody>
              <% contacts.forEach((c, i) => { %>
                <tr>
                  <td data-label="#"> <%= i + 1 %> </td>
                  <td data-label="Name"> <%= c.name %> </td>
                  <td data-label="Email"> <%= c.email %> </td>
                  <td data-label="Phone"> <%= c.phone || '—' %> </td>
                  <td data-label="Message" class="message-cell"><%= c.message %></td>
                  <td data-label="Submitted">
                    <%= new Date(c.date).toLocaleString('en-LS', { timeZone: 'Africa/Maseru' }) %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <p><em>No contact messages yet.</em></p>
      <% } %>

    <% } %>
  </main>
  <%- include('partials/footer') %>
</body>
</html>
