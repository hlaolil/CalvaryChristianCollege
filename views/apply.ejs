<!DOCTYPE html>
<html lang="en">
<%- include('partials/head', { title: title }) %>
<body>
  <%- include('partials/header') %>
  <main class="container">
    <h1>Application Form</h1>

    <% if (success) { %><p class="success">Application submitted successfully!</p><% } %>
    <% if (error) { %><p class="error"><%= error %></p><% } %>

    <!-- ==================== USER FORM ==================== -->
    <% if (user) { %>
      <form action="/apply" method="POST">
        <!-- CSRF (if you use it) -->
        <% if (typeof csrfToken !== 'undefined') { %>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <% } %>

        <!-- Personal Information -->
        <h2>Personal Information</h2>
        <label>Name:</label>
        <input type="text" name="name" value="<%= user.name %>" readonly><br>

        <label>Email:</label>
        <input type="email" name="email" value="<%= user.email %>" readonly><br>

        <label>Phone Number:</label>
        <input type="tel" name="phone" required placeholder="+266 ..."><br>

        <label>Date of Birth:</label>
        <input type="date" name="dob" required><br>

        <label>Street Address:</label>
        <input type="text" name="street_address" required><br>

        <label>Town/City:</label>
        <input type="text" name="town" required><br>

        <label>District:</label>
        <select name="district" required>
          <option value="">Select District</option>
          <% ['Berea','Butha-Buthe','Leribe','Mafeteng','Maseru','Mohale\'s Hoek','Mokhotlong','Qacha\'s Nek','Quthing','Thaba-Tseka'].forEach(d => { %>
            <option value="<%= d %>"><%= d %></option>
          <% }) %>
        </select><br>

        <label>Postal Code:</label>
        <input type="text" name="postal_code" required><br>

        <label>Country:</label>
        <input type="text" name="country" value="Lesotho" readonly><br>

        <!-- High School -->
        <h2>High School Education</h2>
        <label>High School:</label>
        <input type="text" name="high_school" required><br>

        <label>Graduation Year:</label>
        <input type="number" name="grad_year" required min="1900" max="2030"><br>

        <!-- Church / Spiritual -->
        <h2>Church/Spiritual Information</h2>
        <% const yesNo = ['','Yes','No']; %>
        <% ['salvation','baptism','holy_spirit','church_member','ministerial_credentials'].forEach(field => { %>
          <label><%= field.replace(/_/g,' ') %> *:</label>
          <select name="<%= field %>" required>
            <% yesNo.forEach(opt => { %>
              <option value="<%= opt %>"><%= opt || 'Select' %></option>
            <% }) %>
          </select><br>
        <% }) %>

        <label>Current Church Name *:</label>
        <input type="text" name="current_church_name" required><br>

        <label>Current Church City *:</label>
        <input type="text" name="current_church_city" required><br>

        <label>Current Church Country *:</label>
        <input type="text" name="current_church_country" required><br>

        <label>Pastor's Name *:</label>
        <input type="text" name="pastor_name" required><br>

        <label>Church Denominational Affiliation *:</label>
        <input type="text" name="church_denomination" required><br>

        <label>Personal Denominational Affiliation *:</label>
        <input type="text" name="personal_denomination" required><br>

        <label>Ministry Positions *:</label>
        <textarea name="ministry_positions" rows="4" required placeholder="List all current positions..."></textarea><br>

        <label>National Church Leader Name *:</label>
        <input type="text" name="national_leader_name" required><br>

        <label>Position *:</label>
        <input type="text" name="national_leader_position" required><br>

        <label>Address & Contact *:</label>
        <textarea name="national_leader_address" rows="3" required></textarea><br>

        <!-- Program -->
        <h2>Program Information</h2>
        <label>Program:</label>
        <select name="program" required>
          <option value="">Select Program</option>
          <optgroup label="Level 1">
            <option value="Level 1 Certificate in Christian Discipleship">Level 1 Certificate in Christian Discipleship</option>
          </optgroup>
          <optgroup label="Level 2">
            <option value="Level 2 Diploma in Christian Leadership">Level 2 Diploma in Christian Leadership</option>
            <option value="Level 2 Certificate in Theology">Level 2 Certificate in Theology</option>
            <option value="Level 2 Certificate in Biblical Studies">Level 2 Certificate in Biblical Studies</option>
          </optgroup>
          <optgroup label="Level 3">
            <option value="Level 3 Advanced Diploma in Ministry">Level 3 Advanced Diploma in Ministry</option>
            <option value="Level 3 Diploma in Theology">Level 3 Diploma in Theology</option>
            <option value="Level 3 Diploma in Biblical Studies">Level 3 Diploma in Biblical Studies</option>
            <option value="Level 3 Diploma in Business Leadership">Level 3 Diploma in Business Leadership</option>
          </optgroup>
          <optgroup label="Level 4">
            <option value="Level 4 Higher Diploma in Shepherding">Level 4 Higher Diploma in Shepherding</option>
          </optgroup>
          <optgroup label="Level 5">
            <option value="Level 5 Bachelor of Ministry">Level 5 Bachelor of Ministry</option>
          </optgroup>
        </select><br>

        <label>Semester:</label>
        <select name="semester" required>
          <option value="">Select Semester</option>
          <option value="January 2026">January 2026</option>
          <option value="July 2026">July 2026</option>
          <option value="January 2027">January 2027</option>
        </select><br>

        <label>Message (Optional):</label>
        <textarea name="message" rows="4"></textarea><br>

        <p><strong>Application Fee: M200</strong></p>
        <button type="submit">Submit Application</button>
      </form>

      <p><a href="/">Back to Home</a></p>

      <!-- ==================== ADMIN: ALL APPLICATIONS ==================== -->
      <% if (user.role === 'admin') { %>
        <hr>
        <h2>All Submitted Applications</h2>

        <% if (applications && applications.length > 0) { %>
          <% applications.forEach((app, index) => { %>
            <details style="margin-bottom:1.5rem; border:1px solid #ccc; padding:1rem; border-radius:8px;">
              <summary style="font-weight:bold; cursor:pointer;">
                #<%= index + 1 %> – <%= app.name %> (<%= app.email %>) – <%= app.program %> – <%= app.semester %>
                <span style="margin-left:1rem; font-weight:normal; color:#666;">
                  Submitted: <%= new Date(app.submittedAt).toLocaleString() %>
                </span>
              </summary>

              <div style="margin-top:1rem; line-height:1.6;">
                <strong>Personal</strong><br>
                Phone: <%= app.phone %> | DOB: <%= new Date(app.dob).toLocaleDateString() %><br>
                Address: <%= app.street_address %>, <%= app.town %>, <%= app.district %> <%= app.postal_code %><br><br>

                <strong>Education</strong><br>
                High School: <%= app.high_school %> | Grad Year: <%= app.grad_year %><br><br>

                <strong>Church</strong><br>
                Salvation: <%= app.salvation %> | Baptism: <%= app.baptism %> | Holy Spirit: <%= app.holy_spirit %><br>
                Church: <%= app.current_church_name %>, <%= app.current_church_city %>, <%= app.current_church_country %><br>
                Pastor: <%= app.pastor_name %> | Member: <%= app.church_member %><br>
                Denomination: <%= app.church_denomination %> | Personal: <%= app.personal_denomination %><br>
                Credentials: <%= app.ministerial_credentials %><br>
                Ministry Positions:<br><pre style="background:#f9f9f9; padding:0.5rem;"><%= app.ministry_positions %></pre><br>

                <strong>National Leader</strong><br>
                Name: <%= app.national_leader_name %> | Position: <%= app.national_leader_position %><br>
                Address:<br><pre style="background:#f9f9f9; padding:0.5rem;"><%= app.national_leader_address %></pre><br>

                <strong>Program</strong><br>
                <%= app.program %> – <%= app.semester %><br>
                <% if (app.message) { %>
                  Message:<br><pre style="background:#f9f9f9; padding:0.5rem;"><%= app.message %></pre>
                <% } %>
              </div>
            </details>
          <% }) %>
        <% } else { %>
          <p><em>No applications submitted yet.</em></p>
        <% } %>
      <% } %>

    <% } else { %>
      <p>You must be logged in to apply. <a href="/auth/login">Login here</a></p>
    <% } %>
  </main>

  <%- include('partials/footer') %>
</body>
</html>
